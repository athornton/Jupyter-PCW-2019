<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<title>Tech Dive: Jupyter at LSST</title>
<meta name="author" content="(Adam Thornton)"/>
<style type="text/css">
.underline { text-decoration: underline; }
</style>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/reveal.js/3.9.2/css/reveal.css"/>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/reveal.js/3.9.2/css/theme/white.css" id="theme"/>

<link rel="stylesheet" href="./local.css"/>

<!-- If the query includes 'print-pdf', include the PDF print sheet -->
<script>
    if( window.location.search.match( /print-pdf/gi ) ) {
        var link = document.createElement( 'link' );
        link.rel = 'stylesheet';
        link.type = 'text/css';
        link.href = 'https://cdnjs.cloudflare.com/ajax/libs/reveal.js/3.9.2/css/print/pdf.css';
        document.getElementsByTagName( 'head' )[0].appendChild( link );
    }
</script>
</head>
<body>
<div class="reveal">
<div class="slides">
<section id="sec-title-slide"><h1 class="title">Tech Dive: Jupyter at LSST</h1><h2 class="author">Adam Thornton</h2><p class="date">Created: 2024-04-27 Sat 09:25</p>
</section>
<section>
<section id="slide-sec-">
<h2 id="org7d1859b">Overview</h2>
<ul>
<li>LSST: What and Why</li>
<li>Architecture: Kubernetes + JupyterHub + JupyterLab</li>
<li>Specific Implementation Challenges and Solutions</li>

</ul>

</section>
</section>
<section>
<section id="slide-sec-">
<h2 id="org3368b28">LSST</h2>
<div class="outline-text-2" id="text-org3368b28">
</div>
</section>
</section>
<section>
<section id="slide-sec-">
<h3 id="org6764fc1">Feeds and Speeds</h3>
<p>
<a href="https://www.lsst.org/scientists/keynumbers">This</a> is the usual overview of what the LSST is going to be doing, and
how much of it there is.
</p>

</section>
</section>
<section>
<section id="slide-sec-">
<h3 id="org804ce9e">Notebook Environment (AKA "nublado")</h3>
<p>
This is the LSST Science Platform Interactive Notebook Component.
Basically, it's a way of letting scientists quickly iterate through
hypotheses looking for the ones interesting enough to burn a lot of
resources investigating.
</p>

<p>
My <a href="https://youtu.be/Xc0rUVznx1k?list=PL055Epbe6d5b572IRmYAHkUgcq3y6K3Ae">talk at JupyterCon 2018</a> (<a href="https://athornton.github.io/JupyterCon-2018-talk">slides</a>) is not a bad overview, if I do say
so myself.
</p>
</section>
</section>
<section>
<section id="slide-sec-">
<h2 id="org8729822">Architectural assumptions</h2>
<div class="outline-text-2" id="text-org8729822">
</div>
</section>
</section>
<section>
<section id="slide-sec-">
<h3 id="orgb4c7b02">Kubernetes is the right level of abstraction</h3>
<p>
You're free to argue with me about this.
</p>

<p>
If you do, you're wrong.
</p>

</section>
<section id="slide-sec-">
<h4 id="orge78d746">Containerization</h4>
<p>
Abstraction that lets you care about the application software rather
than the lower layers.
</p>

<p>
We're using Docker.
</p>

</section>
<section id="slide-sec-">
<h4 id="org7e0b0c5">Composability</h4>
<p>
Kubernetes abstractions (e.g. the service) are designed such that we can
load-balance and (in some cases) get HA without having to work very hard
at it.  The deployment manages container lifecycles so we have the right
number of a given component running.  We don't have to manage the
(miserable) Docker-container-port-to-host-port mapping stuff ourselves.
</p>

<p>
This is where Kubernetes is magnificent.
</p>

</section>
<section id="slide-sec-">
<h4 id="org3b1cc56">Ubiquity</h4>
<div class="outline-text-4" id="text-org3b1cc56">
</div>
<ul class="org-ul">
<li><a id="orgaa1aeba"></a>If you are not a data center service provider<br />
<p>
Demand your service provider give you a Kubernetes interface.  The major
public clouds already do.
</p>


</section>
<section >
</li>

<li><a id="orge04edbd"></a>If you are a data center service provider<br />
<p>
You either already do provide a managed Kubernetes service or you're
going to have to.  The longer you wait the more it will hurt.
</p>

<p>
Again, you can argue with me.  Again, you're wrong.
</p>
</li>
</ul>

</section>
<section id="slide-sec-">
<h4 id="org771212a">Orchestrateable</h4>
<p>
Kustomize, Terraform, Helm, or roll-your own.  Each of the first three
has advantages.
</p>

</section>
</section>
<section>
<section id="slide-sec-">
<h3 id="org757da9c">JupyterHub</h3>
<p>
Why write your own spawner?  I haven't heard a convincing reason.
</p>

</section>
</section>
<section>
<section id="slide-sec-">
<h3 id="orge0bd6e5">JupyterLab</h3>
<p>
No sense in starting, several years from Science First Light, with
something that's already being supplanted.
</p>

<p>
You can still get the Classic Notebook view from it, if you have users
with notebooks that rely on things JupyterLab doesn't have extensions
for.  Encourage them to write those extensions or at least open issues.
</p>

</section>
</section>
<section>
<section id="slide-sec-">
<h2 id="org78786f4">Implementation Challenges and Solutions</h2>
<ol>
<li>Authentication</li>
<li>Resource Control</li>
<li>Configuration</li>
<li>User Environments</li>

</ol>

</section>
</section>
<section>
<section id="slide-sec-">
<h3 id="org4714dbf">Authentication</h3>
<div class="outline-text-3" id="text-org4714dbf">
</div>
</section>
<section id="slide-sec-">
<h4 id="orgeb56e55">Make it someone else's problem</h4>
<p>
It's full of corner cases and harder than it looks.
</p>

<p>
Are you <b>really</b> such a special snowflake that "users are members of
groups, and groups map to capabilities" won't work for you?
</p>

</section>
<section id="slide-sec-">
<h4 id="org26dad68">OAuth2 is nice</h4>
<p>
Wide support, good JupyterHub support, easy to add new providers.
</p>

<p>
<a href="https://github.com/lsst-sqre/nublado/blob/master/jupyterhub/sample_configs/10-authenticator.py">This</a> is our configuration.
</p>

</section>
<section id="slide-sec-">
<h4 id="org0e03cd4">SSO</h4>
<p>
Custom header checking/injection in an Nginx ingress with a diversion
through OAuth2 flow, followed by passing around JWT.
</p>

<p>
Our <a href="https://github.com/lsst-sqre/nublado/blob/master/proxy/kubernetes/ingress.template.yml#L11">ingress annotations</a> and <a href="https://github.com/lsst-sqre/nublado/blob/master/jupyterhub/sample_configs/10-authenticator.py#L315">header validation and parsing</a>.
</p>

<p>
Note that Node.js has a default maximum header size of 8KB.
</p>

</section>
<section id="slide-sec-">
<h4 id="orgcdbab96">Better SSO</h4>
<p>
CILogon+NCSA IDP supports association of identities, which is a nice
feature.  See if your OAuth2 provider can do it.
</p>

<p>
For instance, I'm usually signed into GitHub within ten minutes of
logging on somewhere.
</p>

</section>
</section>
<section>
<section id="slide-sec-">
<h3 id="org00c93e7">Resource Control</h3>
<div class="outline-text-3" id="text-org00c93e7">
</div>
</section>
<section id="slide-sec-">
<h4 id="orga6c4839">Group Membership</h4>
<p>
A group is really a mapping to a set of capabilities.
</p>

<p>
Any reasonable authentication provider should be able to also do
multiple group memberships for an identity.
</p>

</section>
<section id="slide-sec-">
<h4 id="org8e4dcb3">Capabilities are equivalent to resource entitlement</h4>
<p>
What a user is allowed to do is the union of the capabilities of each of
their groups.
</p>

</section>
<section id="slide-sec-">
<h4 id="org13dae64">Namespace a user's resources in Kubernetes</h4>
<div class="outline-text-4" id="text-org13dae64">
</div>
<ul class="org-ul">
<li><a id="org5be37ee"></a>Quotas<br />
<p>
CPU, RAM, and object count.
</p>

<p>
Construct different quotas for different groups.
</p>

</section>
<section >
</li>

<li><a id="orga62e33d"></a>Ease of cleanup<br />
<p>
Once you start constructing complex user environments, it's easy to
leak.
</p>

<p>
Namespace teardown removes all namespaced resources; in our experience,
everything but PVs.
</p>
</li>
</ul>

</section>
<section id="slide-sec-">
<h4 id="org735ca38">Time is a resource</h4>
<p>
If you have a complex set of analysis tools, your images may be very
large.  Ours are 16GB now.
</p>

<p>
This can take a very long time to pull.
</p>

</section>
<section >

<ul class="org-ul">
<li><a id="org7e17ecf"></a>Prepuller<br />
<p>
Run <a href="https://github.com/lsst-sqre/nublado/tree/master/prepuller">something</a> to continually pull some set of versions of your standard
images.  Couple with a CI system and by the time people show up in the
morning, the new image is pulled.
</p>

<p>
Cuts startup time from 10 minutes to 15 seconds for us.
</p>

</section>
<section >
</li>

<li><a id="org99e782e"></a>Build around your stack<br />
<p>
Don't take a base JupyterLab and add your software to it if your
software is large.
</p>

<p>
Instead, add JupyterLab to your software.
</p>
</li>
</ul>

</section>
<section id="slide-sec-">
<h4 id="orgea7777b">Intermediate-scale parallelism</h4>
<div class="outline-text-4" id="text-orgea7777b">
</div>
<ul class="org-ul">
<li><a id="org5b85a9a"></a>Things too big to fit in a single Python process/cell<br />
<p>
Say, a handful of columns across a couple billion rows.
<a href="https://github.com/lsst-sqre/notebook-demo/blob/master/experiments/DASK-notebooks/gaia_all_sky.ipynb">(GAIA DR2, "l" and "b" columns only)</a>
</p>

</section>
<section >
</li>

<li><a id="orgab59e11"></a>But not so big you want to go with full-on HTCondor yet<br />
<p>
LSST DR11 final catalog size: 15PB.
</p>

</section>
<section >
</li>

<li><a id="orge8886c8"></a>We use Dask<br />
<p>
By the end of the survey, much that we would now use a batch environment
for will be reasonable in an interactive Dask-like framework.  15PB of
catalog data?
</p>

</section>
<section >
</li>

<li><a id="orgc6457bb"></a>Considerations for using Dask<br />
<ul class="org-ul">
<li><a id="org4e14eb1"></a>Keeping Python libraries and versions synced<br />
<p>
Use the same container with a <a href="https://github.com/lsst-sqre/nublado/blob/master/jupyterlab/runlab.sh#L135">different environmental flag</a> set to say "be a
Dask worker, not a JupyterLab server."
</p>

<p>
In our environment, both Jupyter machinery and Dask machinery are small
compared to our analysis software.
</p>

</section>
<section >
</li>

<li><a id="org00bbe06"></a>Need additional Role/ServiceAccount/Rolebinding to allow Lab to spawn Dask<br />
<p>
We populate a Dask worker yml document at each login that does the right
thing.  Modify at your own risk and you're still subject to quotas.
</p>

<p>
We anticipate very few users will ever need this level of control.
</p>

</section>
<section >
</li>

<li><a id="orgfe9a1e9"></a>Resource limits can cause worker nodes to get reaped<br />
<p>
Some attention to partitioning is still required.
</p>
</li>
</ul>
</li>

<li><a id="org9e47436"></a>Now the user Lab container has to create other containers<br />
<p>
But in the same namespace, so quotas are still easy.
</p>

</section>
<section >
</li>

<li><a id="org370ddc9"></a>RBAC<br />
<p>
It's not that scary.
</p>

<p>
<a href="https://github.com/lsst-sqre/nublado/tree/master/jupyterhub/kubernetes">This is an example</a> for JupyterHub.
</p>
</li>
</ul>

</section>
</section>
<section>
<section id="slide-sec-">
<h3 id="org3f7f63a">Configuration</h3>
<div class="outline-text-3" id="text-org3f7f63a">
</div>
</section>
<section id="slide-sec-">
<h4 id="org6517bea">Modularity with ConfigMaps</h4>
<p>
This is a <a href="https://github.com/lsst-sqre/nublado/blob/master/jupyterhub/jupyterhub_config/jupyterhub_config.py">JupyterHub minimal configuration wrapper</a> that loads the (sorted)
contents of a configuration directory.
</p>

<p>
This is <a href="https://github.com/lsst-sqre/nublado/blob/master/jupyterhub/sample_configs/30-environment.py">one of the files it loads.</a>
</p>

<p>
Make your ConfigMaps generic.
</p>

</section>
<section id="slide-sec-">
<h4 id="orgf931106">Instance-specific values</h4>
<p>
Put them in templated environment, or in Secrets for sensitive data.
</p>

</section>
<section id="slide-sec-">
<h4 id="org539dec4">Don't be afraid to subclass right in your ConfigMaps</h4>

</section>
</section>
<section>
<section id="slide-sec-">
<h3 id="org10d2ddb">User Environments</h3>
<div class="outline-text-3" id="text-org10d2ddb">
</div>
</section>
<section id="slide-sec-">
<h4 id="org379795e">Use a spawner options form to present choices</h4>
<ul>
<li>Images</li>
<li>Container sizes</li>
<li>Mounted filesystems</li>

</ul>

<p>
You can use groups to control what's displayed.
</p>

</section>
<section id="slide-sec-">
<h4 id="org45392b5">Be the User</h4>
<p>
Pass information into the user container and do user setup as a
semiprivileged user with tightly controlled sudo.
</p>

<p>
Then start the JupyterLab server as the user, in the user's home
directory.
</p>

<p>
Do not give any sudo privileges to the user.
</p>

</section>
<section >

<ul class="org-ul">
<li><a id="org7f58b55"></a>Complex environmental variables<br />
<p>
Set up gid/groupname mappings, uid/username, and parse in the shell on
the far end&#x2026;
</p>

<p>
This is what we've been doing, and we've found we need to&#x2026;
</p>

<ul class="org-ul">
<li><a id="org4c80c1a"></a>base64-encode the really complicated stuff<br />
<p>
<a href="https://github.com/lsst-sqre/nublado/blob/master/jupyterhub/sample_configs/20-spawner.py#L395">Here</a> is how we do our initial Dask container template setup.
</p>

<p>
This gets silly fast.  Instead try:
</p>

</section>
<section >
</li>
</ul>
</li>

<li><a id="org6530e87"></a>ConfigMaps<br />
<p>
Define ConfigMaps (which are namespaced) at spawn time and map them into
the user's Lab container as read-only files.
</p>
</li>
</ul>

</section>
<section id="slide-sec-">
<h4 id="org8074c38">Persistent Storage</h4>
<p>
You just need a consistent and persistent way to assign uids/gids.
</p>

<p>
Your LDAP system should already do this.  GitHub has unique 32-bit
identifiers for users and groups.  Google will require you to map 64-bit
IDs to 32-bit.
</p>

</section>
<section >

<ul class="org-ul">
<li><a id="orga92176e"></a>Access Control is now a solved problem<br />
<p>
You can use POSIX ACLs if there's something good old file permissions
can't handle.
</p>

</section>
<section >
</li>

<li><a id="org6a91904"></a>NFS<br />
<p>
Works, ubiquitous, <span class="underline">but</span>&#x2026;
</p>

<ul>
<li>Performance</li>
<li>Locking</li>
<li>The use of non-default NFS options in Kubernetes requires hacky
workarounds</li>

</ul>

</section>
<section >
</li>

<li><a id="orgabf7ccc"></a>HostPath<br />
<p>
"Get out of jail free."
</p>

<ul>
<li>Jails exist for reasons.</li>
<li>Not officially supported for ReadWriteMany.</li>
<li>GPFS seems to work for us, with good performance, but YMMV.</li>

</ul>
</li>
</ul>

</section>
</section>
<section>
<section id="slide-sec-">
<h2 id="orgc09ef9e">Links</h2>
<div class="outline-text-2" id="text-orgc09ef9e">
</div>
</section>
</section>
<section>
<section id="slide-sec-">
<h3 id="org5691b71">This Talk</h3>
<p>
<a href="https://github.com/lsst-sqre/Jupyter-PCW-2019.git">
This talk (source)</a>: <a href="https://github.com/lsst-sqre/Jupyter-PCW-2019.git">https://github.com/lsst-sqre/Jupyter-PCW-2019.git</a>.
</p>

<p>
<a href="https://athornton.github.io/Jupyter-PCW-2019">This talk</a>: <a href="https://athornton.github.io/Jupyter-PCW-2019">https://athornton.github.io/Jupyter-PCW-2019</a>.
</p>

</section>
</section>
<section>
<section id="slide-sec-">
<h3 id="org629b070">Useful Repositories</h3>
<p>
The <a href="https://github.com/lsst-sqre/nublado.git">Notebook Aspect of the LSST Science Platform</a>:
<a href="https://github.com/lsst-sqre/nublado.git">https://github.com/lsst-sqre/nublado.git</a> (example sources).
</p>

<p>
<a href="https://github.com/lsst-sqre/jupyterhubutils">LSST JupyterHub Utilities</a>:
<a href="https://github.com/lsst-sqre/jupyterhubutils">https://github.com/lsst-sqre/jupyterhubutils</a> (prepuller and
reposcanner).
</p>

<p>
<a href="https://github.com/lsst-sqre/jupyterlabutils">LSST JupyterLab Utilities</a>:
<a href="https://github.com/lsst-sqre/jupyterlabutils">https://github.com/lsst-sqre/jupyterlabutils</a> (Dask cluster proxy for use
in Kubernetes).
</p>

</section>
</section>
<section>
<section id="slide-sec-">
<h2 id="orgf6db154">Questions</h2>
<p>
<a href="https://athornton.github.io/Jupyter-PCW-2019">This talk</a>: <a href="https://athornton.github.io/Jupyter-PCW-2019">https://athornton.github.io/Jupyter-PCW-2019</a>.
</p>

<p>
Adam Thornton &lt;athornton@lsst.org&gt;
</p>
</section>
</section>
</div>
</div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/reveal.js/3.9.2/lib/js/head.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/reveal.js/3.9.2/js/reveal.js"></script>

<script>
// Full list of configuration options available here:
// https://github.com/hakimel/reveal.js#configuration
Reveal.initialize({

controls: true,
progress: true,
history: false,
center: true,
slideNumber: 'c',
rollingLinks: false,
keyboard: true,
overview: true,

theme: Reveal.getQueryHash().theme, // available themes are in /css/theme
transition: Reveal.getQueryHash().transition || 'default', // default/cube/page/concave/zoom/linear/fade/none
transitionSpeed: 'default',
multiplex: {
    secret: '', // null if client
    id: '', // id, obtained from socket.io server
    url: '' // Location of socket.io server
},

// Optional libraries used to extend on reveal.js
dependencies: [
 { src: 'https://cdnjs.cloudflare.com/ajax/libs/reveal.js/3.9.2/lib/js/classList.js', condition: function() { return !document.body.classList; } },
 { src: 'https://cdnjs.cloudflare.com/ajax/libs/reveal.js/3.9.2/plugin/markdown/marked.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
 { src: 'https://cdnjs.cloudflare.com/ajax/libs/reveal.js/3.9.2/plugin/markdown/markdown.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
 { src: 'https://cdnjs.cloudflare.com/ajax/libs/reveal.js/3.9.2/plugin/zoom-js/zoom.js', async: true, condition: function() { return !!document.body.classList; } },
 { src: 'https://cdnjs.cloudflare.com/ajax/libs/reveal.js/3.9.2/plugin/notes/notes.js', async: true, condition: function() { return !!document.body.classList; } }]
});
</script>
</body>
</html>
